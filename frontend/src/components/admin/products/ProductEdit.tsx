import React, { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import type { Product } from "../../../interfaces/Product";
import {
  FaArrowLeft,
  FaPlus,
  FaTrash,
  FaSave,
  FaExclamationCircle,
} from "react-icons/fa";
import {
  Form,
  Input,
  InputNumber,
  Select,
  Button,
  message,
  Card,
  Switch,
  Divider,
  Row,
  Col,
  Collapse,
  Alert,
  Tabs,
  Spin,
  Upload,
  TreeSelect,
  Typography,
  Space,
  UploadFile,
  UploadProps,
} from "antd";
import VariantManager from "./VariantManager";
import {
  PlusOutlined,
  UploadOutlined,
  ArrowLeftOutlined,
  SaveOutlined,
} from "@ant-design/icons";
import slugify from "slugify";
import { getCategories, getBrands, getProductById, updateProduct } from "./api";
import { Category } from "../../../interfaces/Category";
import { Brand } from "../../../interfaces/Brand";
import SpecificationEditor from "./SpecificationEditor";

const { TextArea } = Input;
const { Panel } = Collapse;
const { TabPane } = Tabs;
const { Title, Text } = Typography;
const API_URL = "http://localhost:9000/api/product";

interface ProductVariant {
  id: string;
  name: string;
  sku: string;
  price: number;
  salePrice?: number;
  stock: number;
  color?: string;
  size?: string;
  weight?: number;
  images: string[];
  isActive: boolean;
}

const ProductEdit: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [categories, setCategories] = useState<Category[]>([]);
  const [brands, setBrands] = useState<Brand[]>([]);
  const [images, setImages] = useState<string[]>([""]);
  const [specifications, setSpecifications] = useState<{
    [key: string]: string;
  }>({});
  const [features, setFeatures] = useState<string[]>([]);
  const [variants, setVariants] = useState<ProductVariant[]>([]);
  const [product, setProduct] = useState<Product | null>(null);
  const [previewImage, setPreviewImage] = useState<string>("");
  const [fileList, setFileList] = useState<UploadFile[]>([]);

  const getAuthHeader = () => {
    const token = localStorage.getItem("token");
    return {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
    };
  };

  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const name = e.target.value;
    const slug = slugify(name, { lower: true, strict: true });
    form.setFieldsValue({ slug });
  };

  useEffect(() => {
    if (!id) {
      message.error("ID S·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá.");
      navigate("/admin/products");
      return;
    }

    const fetchData = async () => {
      try {
        const [productData, cats, brs] = await Promise.all([
          getProductById(id),
          getCategories(),
          getBrands(),
        ]);
        setCategories(cats);
        setBrands(brs);
        setSpecifications({ ...(productData.specifications || {}) });
        setVariants(productData.variants || []);
        setImages(productData.images || []);
        if (productData.images?.length > 0) {
          setPreviewImage(productData.images[0]);
        }
        form.setFieldsValue({
          name: productData.name,
          slug: productData.slug,
          description: productData.description,
          price: productData.price,
          salePrice: productData.salePrice,
          stock: productData.stock,
          sku: productData.sku,
          brand: productData.brand?._id || productData.brand,
          category: productData.category?._id || productData.category,
          weight: productData.weight,
          warranty: productData.warranty,
          tags: productData.tags || [],
          isActive: productData.isActive,
          isFeatured: productData.isFeatured,
          dimensions: {
            length: productData.dimensions?.length || 0,
            width: productData.dimensions?.width || 0,
            height: productData.dimensions?.height || 0,
          },
        });
      } catch (error) {
        message.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m.");
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, [id, form, navigate]);

  const categoryTree = buildCategoryTree(categories);

  const handleSubmit = async (values: any) => {
    if (!id) return;
    setSubmitting(true);
    try {
      const uploadedImageUrls = fileList
        .map((file) => {
          // N·∫øu file c√≥ response t·ª´ server (file m·ªõi upload), l·∫•y url t·ª´ response
          if (file.response && file.response.url) return file.response.url;
          // N·∫øu file ƒë√£ c√≥ url (·∫£nh c≈©), gi·ªØ nguy√™n url
          if (file.url) return file.url;
          return null;
        })
        .filter((url): url is string => url !== null);

      const productData: Partial<Product> = {
        ...values,
        brand:
          typeof values.brand === "object" ? values.brand._id : values.brand,
        category:
          typeof values.category === "object"
            ? values.category._id
            : values.category,
        images: images.filter((img) => img.trim() !== ""),
        variants: variants,
        slug: slugify(values.name, { lower: true, strict: true }),
        specifications: specifications || {},
      };
      console.log(
        "üì¶ G·ª≠i API updateProduct v·ªõi d·ªØ li·ªáu:",
        JSON.stringify(productData, null, 2)
      );
      await updateProduct(id, productData);
      message.success("C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!");
      navigate("/admin/products");
    } catch (error) {
      // message is handled in api.ts
    } finally {
      setSubmitting(false);
    }
  };

  const handleUploadChange: UploadProps["onChange"] = ({
    fileList: newFileList,
  }) => {
    setFileList(newFileList);
    if (newFileList.length > 0) {
      const firstFile = newFileList.find(
        (f) => f.status === "done" || f.originFileObj
      );
      if (firstFile) {
        if (firstFile.url) {
          setPreviewImage(firstFile.url);
        } else if (firstFile.originFileObj) {
          const reader = new FileReader();
          reader.onload = (e) => setPreviewImage(e.target?.result as string);
          reader.readAsDataURL(firstFile.originFileObj);
        }
      }
    } else {
      setPreviewImage("");
    }
  };

  const uploadProps: UploadProps = {
    action: "https://api.cloudinary.com/v1_1/your_cloudinary_name/image/upload", // THAY TH·∫æ
    listType: "picture-card",
    fileList,
    onChange: handleUploadChange,
    multiple: true,
    data: {
      upload_preset: "your_upload_preset", // THAY TH·∫æ
    },
    onPreview: async (file) => {
      let src = file.url as string;
      if (!src) {
        src = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.readAsDataURL(file.originFileObj as any);
          reader.onload = () => resolve(reader.result as string);
        });
      }
      const image = new Image();
      image.src = src;
      const imgWindow = window.open(src);
      imgWindow?.document.write(image.outerHTML);
    },
  };

  const handleImageChange = (value: string, idx: number) => {
    const newImages = [...images];
    newImages[idx] = value;
    setImages(newImages);
    if (idx === 0) setPreviewImage(value);
  };

  const addImageField = () => setImages([...images, ""]);

  const removeImageField = (idx: number) => {
    const newImages = images.filter((_, i) => i !== idx);
    setImages(newImages);
    if (idx === 0 && newImages.length > 0) setPreviewImage(newImages[0]);
    if (newImages.length === 0) setPreviewImage("");
  };

  if (loading) {
    return (
      <div className="p-6 bg-gray-100 min-h-screen flex justify-center items-center">
        <Spin size="large" />
      </div>
    );
  }

  return (
    <div className="p-6 bg-gray-100 min-h-screen">
      <Form
        form={form}
        layout="vertical"
        onFinish={handleSubmit}
        onFinishFailed={() =>
          message.error("Vui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng th√¥ng tin!")
        }
      >
        <Row gutter={24}>
          <Col xs={24} lg={16}>
            <Card className="shadow-lg rounded-xl mb-6">
              <Title level={4}>Th√¥ng tin chung</Title>
              <Form.Item
                name="name"
                label="T√™n s·∫£n ph·∫©m"
                rules={[{ required: true }]}
              >
                <Input
                  placeholder="VD: √Åo thun nam"
                  onChange={handleNameChange}
                />
              </Form.Item>
              <Form.Item name="slug" label="Slug (URL th√¢n thi·ªán)">
                <Input placeholder="VD: ao-thun-nam" readOnly />
              </Form.Item>
              <Form.Item name="description" label="M√¥ t·∫£ chi ti·∫øt">
                <Input.TextArea
                  rows={6}
                  placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt cho s·∫£n ph·∫©m..."
                />
              </Form.Item>
            </Card>

            <Card className="shadow-lg rounded-xl mb-6">
              <Title level={4}>H√¨nh ·∫£nh s·∫£n ph·∫©m</Title>
              {images.map((img, idx) => (
                <Space key={idx} align="start" className="mb-2 w-full">
                  <Input
                    placeholder="Nh·∫≠p link ·∫£nh..."
                    value={img}
                    onChange={(e) => handleImageChange(e.target.value, idx)}
                    className="w-full"
                  />
                  <Button
                    danger
                    onClick={() => removeImageField(idx)}
                    disabled={images.length === 1}
                  >
                    X√≥a
                  </Button>
                </Space>
              ))}
              <Button
                type="dashed"
                icon={<PlusOutlined />}
                onClick={addImageField}
                className="mt-2"
              >
                Th√™m link ·∫£nh
              </Button>
              <Text type="secondary" className="block mt-2">
                Nh·∫≠p link ·∫£nh s·∫£n ph·∫©m. ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† ·∫£nh ƒë·∫°i di·ªán.
              </Text>
            </Card>

            <Card className="shadow-lg rounded-xl mb-6">
              <Title level={4}>Gi√° & Kho h√†ng</Title>
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item
                    name="price"
                    label="Gi√° g·ªëc"
                    rules={[{ required: true }]}
                  >
                    <InputNumber className="w-full" addonAfter="VND" min={0} />
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item name="salePrice" label="Gi√° khuy·∫øn m√£i">
                    <InputNumber className="w-full" addonAfter="VND" min={0} />
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item
                    name="stock"
                    label="S·ªë l∆∞·ª£ng t·ªìn kho"
                    rules={[{ required: true }]}
                  >
                    <InputNumber className="w-full" min={0} />
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item name="sku" label="SKU">
                    <Input placeholder="VD: ATN-001" />
                  </Form.Item>
                </Col>
              </Row>
            </Card>

            <Card className="shadow-lg rounded-xl mb-6">
              <Title level={4}>Th√¥ng s·ªë k·ªπ thu·∫≠t</Title>
              <SpecificationEditor
                value={specifications}
                onChange={setSpecifications}
              />
            </Card>

            <Card className="shadow-lg rounded-xl mb-6">
              <Title level={4}>Th√¥ng tin b·ªï sung</Title>
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item name="weight" label="C√¢n n·∫∑ng (gram)">
                    <InputNumber className="w-full" min={0} />
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item name="warranty" label="B·∫£o h√†nh (th√°ng)">
                    <InputNumber className="w-full" min={0} />
                  </Form.Item>
                </Col>
              </Row>
              <Form.Item label="K√≠ch th∆∞·ªõc (D√†i x R·ªông x Cao)">
                <Space.Compact>
                  <Form.Item name={["dimensions", "length"]} noStyle>
                    <InputNumber placeholder="D√†i (cm)" min={0} />
                  </Form.Item>
                  <Form.Item name={["dimensions", "width"]} noStyle>
                    <InputNumber placeholder="R·ªông (cm)" min={0} />
                  </Form.Item>
                  <Form.Item name={["dimensions", "height"]} noStyle>
                    <InputNumber placeholder="Cao (cm)" min={0} />
                  </Form.Item>
                </Space.Compact>
              </Form.Item>
              <Form.Item name="tags" label="Tags (ph√¢n c√°ch b·ªüi d·∫•u ph·∫©y)">
                <Select
                  mode="tags"
                  style={{ width: "100%" }}
                  placeholder="VD: √°o nam, th·ªùi trang"
                />
              </Form.Item>
            </Card>

            <Card className="shadow-lg rounded-xl mb-6">
              <VariantManager
                variants={variants}
                onVariantsChange={setVariants}
              />
            </Card>
          </Col>

          <Col xs={24} lg={8}>
            <Card className="shadow-lg rounded-xl sticky top-6">
              <Title level={4}>T·ªï ch·ª©c</Title>
              <Form.Item
                name="category"
                label="Danh m·ª•c"
                rules={[{ required: true }]}
              >
                <TreeSelect
                  treeData={categoryTree}
                  placeholder="Ch·ªçn danh m·ª•c"
                  treeDefaultExpandAll
                  allowClear
                />
              </Form.Item>
              <Form.Item
                name="brand"
                label="Th∆∞∆°ng hi·ªáu"
                rules={[{ required: true }]}
              >
                <Select
                  placeholder="Ch·ªçn th∆∞∆°ng hi·ªáu"
                  options={brands.map((b) => ({ label: b.name, value: b._id }))}
                  allowClear
                />
              </Form.Item>
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item
                    name="isFeatured"
                    label="N·ªïi b·∫≠t"
                    valuePropName="checked"
                  >
                    <Switch />
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item
                    name="isActive"
                    label="Hi·ªÉn th·ªã"
                    valuePropName="checked"
                  >
                    <Switch />
                  </Form.Item>
                </Col>
              </Row>

              <Divider />

              <Title level={4}>Xem tr∆∞·ªõc ·∫£nh</Title>
              {previewImage ? (
                <img
                  src={previewImage}
                  alt="Preview"
                  style={{
                    width: "100%",
                    borderRadius: "8px",
                    marginBottom: "1rem",
                  }}
                />
              ) : (
                <div className="h-48 flex items-center justify-center bg-gray-200 rounded-lg mb-4">
                  <Text type="secondary">Ch∆∞a c√≥ ·∫£nh</Text>
                </div>
              )}

              <Divider />

              <Title level={4}>H√†nh ƒë·ªông</Title>
              <Space direction="vertical" className="w-full">
                <Button
                  type="primary"
                  htmlType="submit"
                  loading={submitting}
                  block
                  icon={<SaveOutlined />}
                >
                  L∆∞u thay ƒë·ªïi
                </Button>
                <Button
                  block
                  icon={<ArrowLeftOutlined />}
                  onClick={() => navigate("/admin/products")}
                >
                  Quay l·∫°i
                </Button>
              </Space>
            </Card>
          </Col>
        </Row>
      </Form>
    </div>
  );
};

const buildCategoryTree = (
  categories: Category[],
  parentId: string | null = null
): any[] => {
  return categories
    .filter((cat) => (cat.parent?._id || cat.parent) === parentId)
    .map((cat) => ({
      title: cat.name,
      value: cat._id,
      children: buildCategoryTree(categories, cat._id),
    }));
};

export default ProductEdit;
